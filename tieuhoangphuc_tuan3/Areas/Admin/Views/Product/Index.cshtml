@model IEnumerable<WebBanDienThoai.Models.Product>

@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Danh sách sản phẩm";
}

<h2 class="text-center text-primary mb-4">📋 Danh sách sản phẩm (Admin)</h2>

<!-- ⚠️ Cảnh báo sản phẩm tồn kho thấp -->
@if (ViewBag.LowStockProducts != null && ViewBag.LowStockProducts.Count > 0)
{
    <div class="alert alert-warning shadow-sm p-3 mb-4">
        <h5 class="mb-2 text-danger">
            ⚠️ Cảnh báo: Có @ViewBag.LowStockProducts.Count sản phẩm sắp hết hàng!
        </h5>
        <ul class="mb-0">
            @foreach (var p in ViewBag.LowStockProducts)
            {
                <li>
                    <strong>@p.Name</strong> - Còn lại:
                    <span class="badge bg-danger">@p.Quantity</span> chiếc
                    (Ngưỡng cảnh báo: <strong>@p.MinStockLevel</strong>)
                </li>
            }
        </ul>
    </div>
}

<!-- Form tìm kiếm và sắp xếp -->
<form method="get" class="mb-4 d-flex gap-2">
    <input type="text" name="searchTerm" value="@ViewBag.CurrentSearch" class="form-control w-25"
           placeholder="Nhập tên sản phẩm..." />

    <select name="sortOrder" class="form-select w-25">
        <option value="">Sắp xếp</option>
        <option value="price_asc" selected="@(ViewBag.CurrentSort == "price_asc")">Giá tăng dần</option>
        <option value="price_desc" selected="@(ViewBag.CurrentSort == "price_desc")">Giá giảm dần</option>
    </select>

    <button type="submit" class="btn btn-primary">Tìm kiếm</button>
</form>

<a href="@Url.Action("Add", "Product", new { area = "Admin" })" class="btn btn-success mb-3">
    <i class="fas fa-plus"></i> Thêm sản phẩm mới
</a>

<table class="table table-bordered table-hover shadow-sm">
    <thead class="table-dark text-center">
        <tr>
            <th class="image-col">Hình ảnh</th>
            <th class="name-col">Tên</th>
            <th class="price-col">Giá</th>
            <th class="discount-col">Giảm giá (%)</th>
            <th class="quantity-col">Tồn kho</th>
            <th class="minstock-col">Ngưỡng cảnh báo</th>
            <th class="category-col">Danh mục</th>
            <th class="subcategory-col">Phân loại</th>
            <th class="action-col">Hành động</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var item in Model)
        {
            <tr class="@(item.Quantity <= item.MinStockLevel ? "table-warning" : "")">
                <td class="image-col text-center">
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <img src="@item.ImageUrl" alt="Ảnh sản phẩm" width="80" height="80" class="rounded shadow-sm" />
                    }
                </td>

                <td class="name-col">@item.Name</td>

                <td class="price-col text-center">
                    <strong>@item.Price.ToString("N0") VNĐ</strong>
                </td>

                <td class="discount-col text-center">
                    @if (item.DiscountPercent > 0)
                    {
                        <span class="text-success">@item.DiscountPercent %</span>
                    }
                    else
                    {
                        <span class="text-muted">Không có</span>
                    }
                </td>

                <!-- 🧮 Cột tồn kho -->
                <td class="quantity-col text-center">
                    @if (item.Quantity <= item.MinStockLevel)
                    {
                        <span class="badge bg-danger">@item.Quantity</span>
                    }
                    else
                    {
                        <span class="badge bg-success">@item.Quantity</span>
                    }
                </td>

                <!-- 🔔 Ngưỡng cảnh báo -->
                <td class="minstock-col text-center">@item.MinStockLevel</td>

                <td class="category-col">@item.Category?.Name</td>
                <td class="subcategory-col">@item.SubCategory?.Name</td>

                <td class="action-col text-center">
                    <div class="d-flex flex-column align-items-center gap-2">
                        <a href="@Url.Action("Display", "Product", new { area = "Admin", id = item.Id })" class="btn btn-info btn-sm w-100 mb-1">
                            <i class="fas fa-eye"></i> Xem
                        </a>
                        <a href="@Url.Action("Update", "Product", new { area = "Admin", id = item.Id })" class="btn btn-warning btn-sm w-100 mb-1">
                            <i class="fas fa-edit"></i> Sửa
                        </a>
                        <form action="@Url.Action("DeleteConfirmed", "Product", new { area = "Admin" })" method="post" style="width:100%;"
                              onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này?');">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button type="submit" class="btn btn-danger btn-sm w-100">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- 🎨 CSS chỉnh layout -->
<style>
    .table td, .table th {
        vertical-align: middle !important;
        padding: 8px;
    }

    .name-col {
        width: 220px;
        text-align: left;
    }

    .price-col {
        width: 120px;
        text-align: center;
    }

    .discount-col {
        width: 90px;
        text-align: center;
    }

    .quantity-col {
        width: 90px;
        text-align: center;
    }

    .minstock-col {
        width: 110px;
        text-align: center;
    }

    .category-col, .subcategory-col {
        width: 120px;
        text-align: center;
    }

    .subcategory-col {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }

    .action-col {
        width: 120px;
        text-align: center;
    }

        .action-col .btn {
            width: 100%;
            margin-bottom: 7px;
        }

            .action-col .btn:last-child {
                margin-bottom: 0 !important;
            }

    .description-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
